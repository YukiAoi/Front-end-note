# 回流与重绘

## 是什么

- 回流：当 DOM 的变化影响了元素的几何信息，浏览器需要重新计算元素的几何属性，将其安放在界面中的正确位置，这个过程叫做重排。表现为重新生成布局，重新排列元素
- 重绘：当一个元素的外观发生改变，但没有改变布局,重新把元素外观绘制出来的过程，叫做重绘。表现为某些元素的外观被改变

## 怎么触发

### 回流触发时机

当页面布局和几何信息发生变化的时候，就需要回流：

- 添加或删除可见的 DOM 元素
- 元素的位置发生变化
- 元素的尺寸发生变化（包括外边距、内边框、边框大小、高度和宽度等）
- 内容发生变化，比如文本变化或图片被另一个不同尺寸的图片所替代
- 页面一开始渲染的时候（这避免不了）
- 浏览器的窗口尺寸变化（因为回流是根据视口的大小来计算元素的位置和大小的）
- 获取需要通过即时计算的值：
  - offsetTop
  - offsetLeft
  - offsetWidth
  - offsetHeight
  - scrollTop
  - scrollLeft
  - scrollWidth
  - scrollHeight
  - clientTop
  - clientLeft
  - clientWidth
  - clientHeight

### 重绘触发时机

触发回流一定会触发重绘

除此外还有：

- 颜色的修改
- 文本方向的修改
- 阴影的修改
- 形状的改变

### 浏览器优化机制

大多数浏览器都会通过队列化修改并批量执行来优化重排过程。浏览器会将修改操作放入到队列里，直到过了一段时间或者操作达到了一个阈值，才清空队列

当你获取布局信息的操作的时候，会强制队列刷新，包括前面讲到的 offsetTop 等方法都会返回最新的数据

因此浏览器不得不清空队列，触发回流重绘来返回正确的值

## 如何减少回流与重绘

- 如果想设定元素的样式，通过改变元素的 class 类名
- 避免设置多项内联样式
- 应用元素的动画，使用 position 属性的 fixed 值或 absolute 值
- 避免使用 table 布局，table 中每个元素的大小以及内容的改动，都会导致整个 table 的重新计算
- 对于那些复杂的动画，对其设置 position: fixed/absolute，尽可能地使元素脱离文档流，从而减少对其他元素的影响
- 使用 css3 硬件加速，可以让 transform、opacity、filters 这些动画不会引起回流重绘
- 避免使用 CSS 的 JavaScript 表达式
